#!/usr/bin/env python

from system_database import SYSTEM_DATABASE
import string, os, socket

FQDN=socket.getfqdn()
LOCAL_DOMAIN=string.join(string.split(FQDN,'.')[1:],'.')

HOSTS_PREAMBLE="""
### File generated by dns-regen -- no manual edits allowed
"""
HOSTS_POSTAMBLE="""
"""

# double up the literal percents here. Didn't have to do that on the
# triple-quoted strings, since those don't get parsed the same way
# DNS_FORWARD_LINE="%s.%% a %s ~\n" # hostname, ip
# DNS_REVERSE_LINE="%s.in-addr.arpa. ptr %s.%% ~\n" # reversed ip, hostname
HOSTS_LINE="%s %s %s\n" # ip, fqdn, alias

def main():
    with open('/etc/dnsmasq.hosts','w') as hosts:
        hosts.write(HOSTS_PREAMBLE)
        for entry in SYSTEM_DATABASE:
            hostname, mac, ip = entry
            fqdn = "%s.%s" % (hostname, LOCAL_DOMAIN)
            hosts.write(HOSTS_LINE % (ip, fqdn, hostname))
        hosts.write(HOSTS_POSTAMBLE)

    os.system("/etc/init.d/dnsmasq restart")

if __name__ == "__main__":
    main()
