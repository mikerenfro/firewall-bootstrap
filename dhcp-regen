#!/usr/bin/env python

from system_database import SYSTEM_DATABASE_LOC, SYSTEM_DATABASE_DMZ, DEFAULT_DOMAIN
import string, os, socket

FQDN=socket.getfqdn()
LOCAL_DOMAIN=string.join(string.split(FQDN,'.')[1:],'.')

DHCP_PREAMBLE="""### File generated by dhcp-regen --
### no manual edits allowed
ddns-update-style none;
option domain-name "~LOCAL_DOMAIN~";
option domain-name-servers __ETH1_IP__;
default-lease-time 600;
max-lease-time 7200;
authoritative;
log-facility local7;
allow booting;
subnet __ETH1_NETWORK__ netmask __ETH1_NETMASK__ {
  range __ETH1_DHCP_START__ __ETH1_DHCP_END__;
  option routers __ETH1_IP__;
  option broadcast-address __ETH1_BROADCAST__;
  next-server __ETH1_IP__;
}
subnet __ETH2_NETWORK__ netmask __ETH2_NETMASK__ {
  range __ETH2_DHCP_START__ __ETH2_DHCP_END__;
  option routers __ETH2_IP__;
  option broadcast-address __ETH2_BROADCAST__;
  next-server __ETH2_IP__;
}
"""
DHCP_HOST_LINE="""host %s
  { hardware ethernet %s;
    fixed-address %s;
    filename "/pxelinux.0"; }
"""

DHCP_PREAMBLE = DHCP_PREAMBLE.replace('~LOCAL_DOMAIN~',DEFAULT_DOMAIN)

def main():
    with open('/etc/dhcp/dhcpd.conf','w') as dhcpd_conf:
        dhcpd_conf.write(DHCP_PREAMBLE)
        for entry in SYSTEM_DATABASE:
            hostname, mac, ip = ( entry['host'],
                                  entry['mac'],
                                  entry['ip'] )
            dhcpd_conf.write(DHCP_HOST_LINE % (hostname, mac, ip))

    os.system("service isc-dhcp-server restart")

if __name__ == "__main__":
    main()
