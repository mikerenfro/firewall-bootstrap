#!/usr/bin/env python

from system_database import SYSTEM_DATABASE
import string, os, socket

FQDN=socket.getfqdn()
LOCAL_DOMAIN=string.join(string.split(FQDN,'.')[1:],'.')

DHCP_PREAMBLE="""### File generated by dhcp-regen --
### no manual edits allowed
ddns-update-style none;
option domain-name "~LOCAL_DOMAIN~";
option domain-name-servers 192.168.0.1;
default-lease-time 600;
max-lease-time 7200;
authoritative;
log-facility local7;
allow booting;
subnet 192.168.0.0 netmask 255.255.255.0 {
  range 192.168.0.100 192.168.0.254;
  option routers 192.168.0.1;
  option broadcast-address 192.168.0.255;
  next-server 192.168.0.1;
}
"""
DHCP_HOST_LINE="""host %s
  { hardware ethernet %s;
    fixed-address %s;
    filename "/pxelinux.0"; }
"""

DHCP_PREAMBLE = DHCP_PREAMBLE.replace('~LOCAL_DOMAIN~',LOCAL_DOMAIN)

def main():
    with open('/etc/dhcp/dhcpd.conf','w') as dhcpd_conf:
        dhcpd_conf.write(DHCP_PREAMBLE)
        for entry in SYSTEM_DATABASE:
            hostname, mac, ip = entry
            dhcpd_conf.write(DHCP_HOST_LINE % (hostname, mac, ip))

    os.system("/etc/init.d/isc-dhcp-server restart")

if __name__ == "__main__":
    main()
