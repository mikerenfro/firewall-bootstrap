#!/usr/bin/env python

from system_database import SYSTEM_DATABASE, DEFAULT_DOMAIN
import string, os, socket

FQDN=socket.getfqdn()
LOCAL_DOMAIN=string.join(string.split(FQDN,'.')[1:],'.')

DHCP_PREAMBLE="""### File generated by dhcp-regen --
### no manual edits allowed
ddns-update-style none;
option domain-name "~LOCAL_DOMAIN~";
option domain-name-servers 10.0.0.254;
default-lease-time 600;
max-lease-time 7200;
authoritative;
log-facility local7;
allow booting;
subnet 10.0.0.0 netmask 255.255.255.0 {
  range 10.0.0.100 10.0.0.253;
  option routers 10.0.0.254;
  option broadcast-address 10.0.0.255;
  next-server 10.0.0.254;
}
"""
DHCP_HOST_LINE="""host %s
  { hardware ethernet %s;
    fixed-address %s;
    filename "/pxelinux.0"; }
"""

DHCP_PREAMBLE = DHCP_PREAMBLE.replace('~LOCAL_DOMAIN~',DEFAULT_DOMAIN)

def main():
    with open('/etc/dhcp/dhcpd.conf','w') as dhcpd_conf:
        dhcpd_conf.write(DHCP_PREAMBLE)
        for entry in SYSTEM_DATABASE:
            hostname, mac, ip = ( entry['host'],
                                  entry['mac'],
                                  entry['ip'] )
            dhcpd_conf.write(DHCP_HOST_LINE % (hostname, mac, ip))

    os.system("service isc-dhcp-server restart")

if __name__ == "__main__":
    main()
